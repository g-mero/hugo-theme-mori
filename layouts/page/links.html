{{ define "main" }}
  {{ with site.Data.links }}
    {{/* Collect all groups and count total links */}}
    {{ $allGroups := slice }}
    {{ $totalLinks := 0 }}
    {{ range $key, $value := . }}
      {{ if ne $key "settings" }}
        {{ $allGroups = $allGroups | append $value }}
      {{ end }}
    {{ end }}

    {{/* Merge groups with same name and count total links */}}
    {{ $groupsMap := dict }}
    {{ range $allGroups }}
      {{ $groupName := .name }}
      {{ if isset $groupsMap $groupName }}
        {{/* Merge items into existing group */}}
        {{ $existing := index $groupsMap $groupName }}
        {{ $mergedItems := $existing.items | append .items }}
        {{ $groupsMap = merge $groupsMap (dict $groupName (merge $existing (dict "items" $mergedItems))) }}
      {{ else }}
        {{/* Add new group */}}
        {{ $groupsMap = merge $groupsMap (dict $groupName .) }}
      {{ end }}
    {{ end }}

    {{/* Convert map back to slice and count total links */}}
    {{ $groups := slice }}
    {{ range $key, $value := $groupsMap }}
      {{ $groups = $groups | append $value }}
      {{ $totalLinks = add $totalLinks (len $value.items) }}
    {{ end }}

    {{ $groups := sort $groups "weight" "asc" }}

    <section>
      {{ partial "page-header.html" (dict "context" $ "title" $.Title "badge" "Page" "meta" (printf `<span>Total %d links</span>` $totalLinks | safeHTML)) }}

      {{ with $.Content }}
        <div class="prose mb-md">
          {{ . }}
        </div>
      {{ end }}
    </section>

    <section class="mt-xl">
      {{ range $groups }}
        <div class="mb-xl last:mb-0">
          <h2 class="fs-base font-600 m-0 mb-md pb-xs border-b border-bd1 c-main">{{ partial "get-localized.html" (dict "data" . "field" "name") }}</h2>
          {{ $items := sort .items "weight" "asc" }}
          {{ partial "links-list.html" (dict "groups" (slice .) "limit" 0 "showGroupName" false) }}
        </div>
      {{ end }}
    </section>
  {{ end }}
{{ end }}
